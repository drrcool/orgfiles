#+title Daily Notes

* 2023-01-09
** Meetings:
*** Node retiring
    Timeline will be approx a year from the annouce date
    All my use cases should be covered

** Projects:
*** qoedash
**** debugging tests:
***** migrating to vitest
After initial pass to migrate, still getting many errors saying =Reference Error: describe not defined=.  :
*Solution*: These were actual errors but because the files were in the =/app= directory from the ts build step. We need to ensure that vitest is only looking in relavent folders for the tests.
*** adhoc
**** Potential of spatial audio:
***** Roger asked for clarification from work in Nov.  Delivered tables were for all devices, but he really just wanted to know about TVs and Smart TVs
***** Refined ask:
***** Status:
- Currently have a prototype query running for a couple days of data. Will verify the data looks good and run for a 28 day window.
- Data flowing into my database =rcool.value_of_premium_audio_f=
***** Work:
****** Query:
#+begin_src sql :tangle ~/allProjects/adhoc/value_of_premium_audio/value_of_premium_audio.sql :results none

WITH denormalized AS (
SELECT
t1.device_type_id,
device_model,
t2.max_concurrent_streams,
t3.hw_category,esn,
case when lower(audio_profiles_value) like '%ddp%' then 1 else 0 end as supports_ddp,
case when lower(audio_profiles_value) like '%atmos%' then 1 else 0 end as supports_atmos,
case when lower(audio_profiles_value) like '%ddp%' and lower(audio_profiles_value) not like '%atmos%'  then 1 else 0 end as supports_ddp_but_not_atmos

FROM
  vault.device_esn_capability_f t1 JOIN
  dse.plan_d t2 ON (t1.plan_id = t2.plan_id) JOIN
  dse.device_type_rollup_d t3 ON (t1.device_type_id = t3.device_type_id)
WHERE
  region_date >= 20230108
  and audio_profiles_value <> ' '
  and audio_profiles_value <> ''
  and audio_profiles_value <> '--'
),

capable AS (
  SELECT denormalized.device_type_id,
    SUM(supports_ddp) as ddp_count,
    SUM(supports_atmos) as atmos_count,
    SUM(1) as device_row_count
  FROM
    denormalized
  GROUP BY 1),

joined as (
SELECT denormalized.*,
capable.ddp_count as ddp_cnt,
capable.atmos_count as atmos_cnt,
capable.device_row_count as device_row_cnt
  from denormalized join capable on (denormalized.device_type_id = capable.device_type_id)
)

INSERT OVERWRITE TABLE rcool.value_of_premium_audio_f
SELECT
  device_type_id,
  hw_category,
  max_concurrent_streams,
  ddp_cnt,
  atmos_cnt,
  device_row_cnt,
  CASE WHEN ddp_cnt > 1000 then 1 else 0 end as supports_ddp,
  CASE WHEN atmos_cnt > 1000 then 1 else 0 end as supports_atmos,
  count(distinct case when supports_ddp=1 then esn else null end) as configured_ddp_cnt,
  count(distinct case when supports_atmos=1 then esn else null end) as configured_atmos_cnt,
  count(distinct esn)  as esn_cnt
FROM joined
GROUP BY 1, 2,3,4,5, 6

#+end_src
****** Table Creation:
#+begin_src sql :tangle nil
DROP TABLE IF EXISTS rcool.value_of_premium_audio_f;
CREATE EXTERNAL TABLE rcool.value_of_premium_audio_f  (
  device_type_id int,
  hw_category string,
  max_concurrent_streams int,
  ddp_count bigint,
  atmos_count bigint,
  row_count bigint,
  supports_ddp int,
  supports_atmos int,
  configured_ddp_cnt bigint,
  configured_atmos_cnt bigint,
  esn_cnt bigint
 )

#+end_src
*** Device reach dash
**** Carenina really wants to understand the reach of ads compared to all devices that support ads
***** As far as I know we don't have a flag that says if a device supports ads playback, but we can derive this from playback data
***** For a given date range, look at =dse.device_activity_sum= and identify devices with non-zero ads playback. These are capable.
* 2023-01-10:
** Meeting with Manish:
***  Asking about the status of operator updates from by netflix versus by partners.
**** I swear I did this, but its no where to be found
*** Doc:
**** [[https://docs.google.com/document/d/17VPPEiP8QWrMI46KXf2_h2IzmUkHt1jDGeSXPXvX4P0/edit#heading=h.4lzm9udah8gp][Doc link]]
*** Figure 4 of the hypothesis section is what we want to get data for and argue.
** Device Reach Dash
*** Add an addressable reach as denominator
**** device_client_rollup_d includes the =is_device_ad_eligible= flag we can use for this
** QoEdash
*** Test Migration completed. Found source of annoying issue and fixed and pushed. All tests passing
** Adhoc: Roger Value of Premium Audio
*** Query to build the NRDP data finished loading.
*** Agg query
#+begin_src  sql :tangle nil :results None
WITH agg as (
  SELECT
  device_type_id,
  hw_category,
  max_concurrent_streams,
  case when ddp_count > 0.1*esn_cnt then 1 else 0 end as supports_ddp,
  case when atmos_count > 0.1*esn_cnt then 1 else 0 end as supports_atmos,
  configured_ddp_cnt,
  configured_atmos_cnt,
  esn_cnt
 FROM rcool.value_of_premium_audio_f
)

SELECT
    SUM(case when supports_ddp = 1 then esn_cnt else 0 end) ddp_capable_cnt,
    SUM(configured_ddp_cnt) as ddp_configured_cnt,
    SUM(case when supports_ddp = 1 and max_concurrent_streams = 4 then esn_cnt else 0 end) as ddp_capable_on_4s,
    SUM(case when max_concurrent_streams = 4 then configured_ddp_cnt else 0 end ) as ddp_configured_devices_on_4s
FROM
  agg
WHERE
  hw_category in ('Smart TV', 'MVPD Set Top Box', 'Set Top Box/Streaming Stick')

#+end_src

Results:
| ddp_capable_cnt | ddp_configured_cnt | ddp_capable_on_4s | ddp_configured_devices_on_4s |
| 557_488_830     | 406_675_186        | 317_811_364       | 233_158_982                  |

Atmos:
#+begin_src sql :tangle nil
WITH agg as (
  SELECT
  device_type_id,
  hw_category,
  max_concurrent_streams,
  case when ddp_count > 0.1*esn_cnt then 1 else 0 end as supports_ddp,
  case when atmos_count > 0.1*esn_cnt then 1 else 0 end as supports_atmos,
  configured_ddp_cnt,
  configured_atmos_cnt,
  esn_cnt
 FROM rcool.value_of_premium_audio_f
)

SELECT
    SUM(case when supports_atmos = 1 then esn_cnt else 0 end) atmos_capable_cnt,
    SUM(configured_atmos_cnt) as atmos_configured_cnt,
    SUM(case when max_concurrent_streams = 4 then configured_atmos_cnt else 0 end ) as atmos_configured_devices_on_4s
FROM
  agg
WHERE
  hw_category in ('Smart TV', 'MVPD Set Top Box', 'Set Top Box/Streaming Stick')


#+end_src

Results:
| atmos_capable | atmos_configured | atmos_capable_on_4s | atmos_configured_on_4s |
| 169_972_896   | 31_639_943       | 85_695_141          | 18_991_917             |

*** Write Up
Hi Roger,

I'm slammed and haven't been able to pull the tablet or phone data yet.  Here are the data for Smart TVs and STBs/MVPDs.

| Feature | # capable (28d) | # configured (28d) | # capable on 4s | # configured on 4s |
| ---     | ---             | ---                | ---             | ---                |
| DDP     | 557.6M          | 406.7M             | 317.8M          | 233.1M             |
| Atmos   | 170M            | 31.6M              | 85.7M           | 19M                |
|         |                 |                    |                 |                    |

These data were pulled for the last 28 days (versus the same time window as the set of results) which explains the small differences between the two. In general (if not always) the DDP constraint is strongest.  Devices with Atmos have DDP and approximately half of DDP devices could still see value in an upgrade to 4S for a feature like spatial audio.

Let me kngw if you have any questions, comments, or feedback
* 2023-01-11
** Late Day start
*** overslept after working all night
** Meetings:
*** Team meeting:
**** Q4 Retro
*** Device Data Sync
***** Live Updates:
***** What will we need to do for qoedash for live?
****** time series may not make the most sense there as they are event driven and more point in time
** Workflow Notes:
*** Handwritten notes:
**** I like these, so if we continue to have them, we need to track them somehow
** Project Updates:
*** Update strategy data:
****  Finished first data pull, largely confirming results from the original memo
**** Working more to pull device first views and trends to argue that the impact radius is small and shrinking
*** Sessionwiz:
**** They want to do show and tell next week for Data & Insights Day
***** would be nice to have something to show, but I'm also hammered. See what we can do.
***** TCAT
****** files are non-404ed again
******* Linux:
#+begin_src sh

sudo sh -c 'curl -sSLf https://file.dta.netflix.com/ocga/builds/tcat/tcat-linux-amd64 -o /usr/local/bin/tcat && chmod +x /usr/local/bin/tcat'

#+end_src
******* Mac Silicon:
#+begin_src sh
sudo sh -c 'curl -sSLf https://file.dta.netflix.com/ocga/builds/tcat/tcat-darwin-arm64 -o /usr/local/bin/tcat && chmod +x /usr/local/bin/tcat'

#+end_src
****** Spec:
******* link:[[https://stash.corp.netflix.com/projects/CLOUDGAMING/repos/ocga/browse/gocga/proto/com/netflix/games/cloud/ocga/telemetry/spec/spec.pb.go#118,329,7331,7333,7343][Here]]
* 2023-01-12:
** Start of day: Pulled an all nighter
*** Then overslept
** Projects:
*** Strategy Update:
**** First Views:
- Device first views have been roughly flat throughout the year when comparing 5.3+ devices that could potentially be updated. With roughly 30% of the device first views being on devices that are updated through partner firmware updates.
- Looking at overall device shifts, streaming sticks, game consoles, and smart tvs have remained flat in terms of their relative mix, there's no sign of streaming sticks taking over the world.
- So our real question becomes is 18% of the updatable population,
**** Overall Results:
- Ignoring devices on 5.2- and MVPD devices, currently 18% of devices that need NRDP updates cannot get runtime updates through either Netflix-controlled updates or updates their a partner store.

| cohort_type     | active_devices_28d | view_seconds_28d | frac_actives | frac_view_secs |
|-----------------+--------------------+------------------+--------------+----------------|
| Netflix Updated |              137.2 |          2882.71 |        68.63 |          63.59 |
| Non-Updating    |              35.94 |           958.13 |        17.98 |          21.14 |
| Partner Store   |              26.77 |           692.43 |        13.39 |          15.27 |

- Using the current  evolution and mix of 5.3 & 6.0+ devices, the mix appears largely flat over time
  + looking at active devices, the mix fraction of TVs, STBs, and game consoles is largely flat

#+CAPTION: Active devices for NRDP devices of all versions show that the relative mix of TVs, STBs and Game Consoles has remained roughly flat in the last few years.  There's no sign of one type of device becoming a new "preferred" streaming method so we expect the relative mix of these devices to remain roughly flat without an external shock.
#+ATTR_HTML: :width 600px
[[~/allprojects/adhoc/update_strategy/actives.png]]


  + device first views are also flat with approx 30% of daily first views being on non-updatable systems

#+CAPTION: The daily device first views share between cohorts determined by the update method. Over time, the relative fraction of first views between those that can be updated by Netflix and those that require partner firmware udpdates has remained roughly constant.
#+ATTR_HTML: :width 600px
[[~/allprojects/adhoc/update_strategy/device_first_views.png]]

**** Doc with results  [[https://docs.google.com/document/d/1BZdxMa0ClROaRGKaYDNcZ1uZP53yZMnxm6EEvs5Gp4k/edit][here]]
**** Added some follow up.  Previous discussion assumed growth of AndroidTV => growth of netflix updating component. But that was simply not true

[[~/allprojects/adhoc/update_strategy/actives_by_cohort.png]]

[[~/allprojects/adhoc/update_strategy/active_share_by_cohort.png]]
*** Roger Adhoc Value of Premium Audio
Test queries are running very slow. Likely to do my qoedash backfill. Going to cancel it and continue.


** Meetings:
* 2023-01-13:
** Projects:
*** QoeDash:
    - Fixed build deploy issue.  Start.sh was rebuilding when there is no need, it would fail, node wouldn't start, so checkhealth API never ran
    - Fixed pqs smoothing
*** Adhoc:
    - Finalized mobile/tablet premium audio query data pull for Roger
*** Device Reach Dash:
    - created =rpt.devicereachdash_population= and added it to workflow alon with ingestion script.
    - since original data has failire reason in the grain, we can't sum over an pre-aggregated metric like this, so
      keeping it a second table.  And we will need to run two queries from the server to formulate response.
* 2023-01-14:
* 2023-01-15:
** Need to write my journal tonight.
*** Figure out a format
*** topic -- why do i run after unavailable and how sure am I that I'm ready to quit
j
** Ads Reach:
[[file:~/Library/CloudStorage/Dropbox/orgmode/projects.org::*NEXT got ingestion scripts running and updated the workflow][* NEXT got ingestion scripts running and updated the workflow]]

** Config:
*** Tweaked tag settings.
*** Made some org changes. Made custom agenda
* 2023-01-17:
** Projects:
** Notes:
*** DONE Fill out quarterly doc :chores:work:
CLOSED: [2023-01-17 Tue 11:00] DEADLINE: <2023-01-17 Tue 17:00>
** QoEDash:
 * Modals: Updating the modal to hawkins
   - updated validation logic
 * Build:
    - build failures coming from "root-access" to some npm files.  According to stack overflow this is due to caching issues. SO now I'm clearing the cache.

** Meetings:
*** Cloud gaming data & metrics:
- March 15 for session level argus 2
- Chris Wein making a second group for alerts and viz
*** Lauren
**** dashboards / metrics that need vis
***** art updates
****** which partners have them which need them. whos adopted it, who is waiting for adoptions
****** pdm has notifications for when partner pulls it
****** key question: does the devices that have them have them?
****** hwo long until the release rolls out
****** stats on user adoption -- where its been release but users have opted not to take it or update
***** Cloud Games okr
****** some fraction of devices that take NRP 7.0 but have an excemption to not run gaming
***** w/Jorem: how long does it take certain, named, parterns get through certifaction process. Te idea being we optimize that process
***** Infield device health / performance:
****** PQS includes aspects that are not actionable
****** how do updates affect performance
****** remove unactionale pieces so we can make decisions about about future updates.   Where a device may not ne abell to handle the new update based on previous
****** can we find network-free metrics?
****** partner facing aspect so it is shown externally
****** internal layer be


****** Idea: can we use something to break out TTR components.
****** What small fraction of metrics can we use to track device health.
****** Devices will be recertification to get 6.0+ we thats a good to measure of device health independent of network
****** What level to track this at?
******* top N things to track extermnallgiy
******* top N things to show internally

****** Partners may ebentuially need to see the results of CI tests in an extenrally facing dashboards
****** Shifting from focus on maily certtification to also include device in the field health
****** CPU and memory performance to know they can't get update to next version
****** what level to rollup tonight
****** what 1,2,3 data points to show to partners
****** what decisins can we make using the data as a whol


***** Sync with Chris
****** all tables will have live and svod ssession
******* live = session thtat uses the live player
******* watching in teh hours after the event -- called dvr model
******* do we need to separaate live from dvr mode
******** probably at some point but not for mvp
******* viewing durations will be update
******* start slate isn't content time, but you can rebuffer, so keep qoe metrics sepaarate
******** rebuffer during slate and rebuffer during content should be tracked different

******** lvie will have encoder to client latency

******** for launch add a live flag, debfault to not including ads, but allow users to op
** Adhoc or Action Items:
*** TODO Process and file notes for today into appropirate sections

*** DONE Quieries for Daniel -- streaming sdk weekly metrics and partner device sdk
CLOSED: [2023-01-17 Tue 23:13]
* 2023-01-18:
** Little progress, first day sober, dylan struggling.
* 2023-01-19:
** Random
*** trying to get keyboard layout setup for work
** Meetings
*** PQS:
**** Get 2.0 out as soon as possible
**** document the process as well as possible someone like Robert or Luciana or anyone in DSE could possibly help with updates/bug fixes
***** how to make changes
***** code standards
***** how to deploy
***** how to deploy to prod
***** roadmap
*** Cindy:
** Projects:
*** QoeDash:
**** Addressable Population Queries:
***** Addressable population isn't running
**** True Crash:
***** new user visible crash thats not user visible: timeout release
****** Do we need to backfill or just implement:
******* TODO DO a small backfill. Probably mostly hits 6.x devices, so a three month backfill will get most of the traffic.

****** TODO sync with Ayesha. I will put in a PR for =streaming_alerts= that mirrors the change to PQS logic.
****** Whats the right away to do this in the future? Two pieces of code use the same logic. We have to update two places. Should use a shared library?
***
* 2023-01-25:
** Long Hiatus due to recovery work
** Train wreck of a personal life:
*** Window shot at.
*** Suspect: Delmy Vanessa Murillo Saldana
**** Number she called from: 669-609-9819
** Projects:
*** Device Reach Dash
**** Problem with addressable fraction on Android TV, Android Mobile, and some Browsers
***** Added temporary fix to the sql query
****** TODO Remove the temporary fixes to the addressable fraction query when the fixes are in place :qoedash:
****** Browsers with volume:
(1109, 2649, 1080, 1222, 1193, 781, 1436, 1224, 1223, 1700,  2739, 1278, 2828, 1580, 4113, 1679,
 1590, 1681, 3880, 1693, 1695)
**** TODO Dashboard is hardly usable without URL parameters add these to the DRD views :qoedash:
